<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>BoliBazaar</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Bootstrap Icons-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->

    <!-- Google fonts-->

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
      rel="stylesheet"
    />

    <!-- SimpleLightbox plugin CSS-->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.css"
      rel="stylesheet"
    />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Navigation-->
    <nav
      class="navbar navbar-expand-lg navbar-light fixed-top py-3 bg-dark"
      id="mainNav"
    >
      <div class="container px-4 px-lg-5">
        <a class="navbar-brand" href="index.html">BoliBazaar</a>
        <button
          class="navbar-toggler navbar-toggler-right"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarResponsive"
          aria-controls="navbarResponsive"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ms-auto my-2 my-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="auctions.html">Auctions</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="add.html">Sell</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="login.html">Login</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="signup.html">Sign Up</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="profile.html">Profile</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container-md rounded mt-5 py-5">
      Lorem ipsum dolor sit amet consectetur adipisicing elit. Sapiente rem
      incidunt tenetur reprehenderit! Quasi ullam quibusdam assumenda error
      suscipit est, odit vitae optio dolorum sapiente! Modi animi fuga veritatis
      rem explicabo. Eius, laboriosam, cupiditate autem deserunt nihil repellat,
      totam minus dolores quis debitis soluta voluptatibus facere vel nisi est
      atque. Perspiciatis optio quibusdam, nesciunt ipsam eum nulla, a,
      repellendus placeat aliquid error minima voluptatum possimus dolore
      consequuntur vitae dolorem autem laboriosam quos beatae rerum nihil
      suscipit accusamus in? Nihil repellat odit quibusdam aliquam quod id
      debitis cum porro, odio reiciendis pariatur autem ex deserunt distinctio
      ipsa molestiae. Perspiciatis, delectus minus ipsum, sit quis recusandae in
      quod aperiam suscipit consectetur ad soluta libero ex incidunt vitae,
      omnis a deserunt illum nisi odit. Maxime doloremque, quaerat optio
      pariatur perferendis cum! Saepe cum ab deserunt vel tenetur repellendus
      molestiae voluptatibus pariatur nam ducimus ipsam aspernatur atque,
      tempore impedit omnis dolor unde quam cumque ad hic fuga magnam. Adipisci
      necessitatibus error dolor natus commodi optio consectetur delectus magni
      voluptate fuga explicabo dolorem nulla culpa molestias officiis labore
      nihil, iusto mollitia perferendis praesentium unde eligendi deserunt
      deleniti. Veritatis aliquam ut quo vel nesciunt qui nihil est adipisci
      quae vitae blanditiis excepturi dolorem, odio ea perspiciatis!
    </div>
    <div
      class="container-md rounded mt-5"
      style="background-image: url(./assets/img/auction_items/img1.jpg)"
    >
      <div class="d-flex align-items-center py-4 bg-body-tertiary">
        <main class="form-signin w-100 m-auto">
          <div class="container">

            <div class="modal" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p>Modal body text goes here.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                  </div>
                </div>
              </div>
            </div>



            <div class="row" id="cardContainer">
              <!-- Cards will be dynamically generated here -->
            </div>
          </div>
        </main>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    </body>
    <script>



let pid;
      async function getProfileData() {
        let authToken = localStorage.getItem("authtoken");
        let headersList = {
          "auth-token": authToken,
        };

        let response = await fetch("http://localhost:5000/api/auth/getuser", {
          method: "POST",
          headers: headersList,
        });

        let profile = document.getElementById("profile");
        let data = await response.json();
        console.log(data);
        pid = data._id;
        return pid;
      }


  async function placeBid(id) {
    const bidAmount = document.getElementById("bidAmount").value;
    console.log(bidAmount,id);
    let headersList = {
 "auth-token":
   localStorage.getItem("authtoken")}

let bodyContent = JSON.stringify({
  "currentBid": {
    "amount": bidAmount,
    "currency": "USD"
  },
  "currentBuyer":await getProfileData(),
}
);

let response = await fetch(`localhost:5000/api/auctionItems/${id}`, { 
  method: "PUT",
  body: bodyContent,
  headers: headersList
});

let data = await response.text();
console.log(data);

  }
  


function generateCard(item, index) {
    const imageSrc = `data:image/jpeg;base64,${arrayBufferToBase64(
      item.images[0].data
    )}`;
    return `
      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card">
          <img src="${imageSrc}" class="card-img-top" alt="...">
          <div class="card-body">
            <h5 class="card-title">${item.title}<span class="badge text-bg-secondary">${item.dealClosed?'Sold':'Open'}</span></h5>
            <p class="card-text">${item.description}</p>
            <p class="card-text">Starting Bid: ${item.startingBid.amount} ${item.startingBid.currency}</p>
            <p class="card-text">Category: ${item.category}</p>
            <p class="card-text">Condition: ${item.condition}</p>
            <p class="card-text">Location: ${item.location.city}, ${item.location.country}</p>
            <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#exampleModal${index}">
              View
            </button>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="exampleModal${index}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <img src="${imageSrc}" class="card-img-top" alt="...">
              <h1 class="card-title">${item.title}</h1>
              <p class="card-text">${item.description}</p>
              <p class="card-text">Starting Bid: ${item.startingBid.amount} ${item.startingBid.currency}</p>
              <h2 class="card-text">Current Bid: ${item.currentBid.amount} ${item.currentBid.currency}</h2>
              <hr>
              <p class="card-text">Category: ${item.category}</p>
              <p class="card-text">Condition: ${item.condition}</p>
              <p class="card-text">Seller ID: ${item.seller}</p>
              <p class="card-text">Location: ${item.location.city}, ${item.location.country}</p>
            </div>
            <div class="input-group mb-3">
  <span class="input-group-text">$</span>
  <input type="number" class="form-control" id="bidAmount" aria-label="Dollar amount (with dot and two decimal places)">
</div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="placeBid(${item._id})">Bid</button>
              <button type="button" class="btn btn-primary"></button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  function arrayBufferToBase64(buffer) {
      let binary = "";
      const bytes = new Uint8Array(buffer);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary);
    }

    function renderCards(items) {
      const cardContainer = document.getElementById("cardContainer");
      if (cardContainer) {
        cardContainer.innerHTML = items
          .map((item, index) => generateCard(item, index))
          .join("");
      }
    }

    async function fetchItems() {
      let headersList = {
        Accept: "*/*",
        "User-Agent": "Thunder Client (https://www.thunderclient.com)",
        "auth-token": localStorage.getItem("authtoken"),
      };

      let response = await fetch("http://localhost:5000/api/auctionItems", {
        method: "GET",
        headers: headersList,
      });

      let data = await response.json();
      console.log(data);

      renderCards(data);
    }

    fetchItems();
  </script>
</html>
